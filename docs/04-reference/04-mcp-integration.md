# Руководство по интеграции MCP (Сводка)

## Проблема

AI-ассистенту требовалось подключение к внешним инструментам (например, `get_all_projects`, `calculator`) через Model Context Protocol.

## Решение

### Архитектура

Интеграция MCP реализована через цепочку `MCPContext → MCPServerManager → fetchAndAssignTools → AIManager`, используя `localStorage`, `SSE/WebSocket` и `JSON-RPC 2.0` для взаимодействия с инструментами AI SDK.

### Настройка сервера

Пример настройки нового MCP-сервера включает `id`, `name`, `url`, `type` (`sse`) и `status`.

### Ключевые исправления

- **Дублирование URL**: Исправлено путем удаления повторяющихся частей домена из URL.
- **Не-JSON ответы**: Обработка не-JSON ответов (например, "Accepted") путем преобразования их в структурированные данные.
- **Синтетические JSON-RPC**: Создание синтетических JSON-RPC ответов для совместимости, особенно для случаев, когда инструменты не возвращают данные.

## Результат

### Улучшения UX

- **Автоматический запуск** серверов после добавления.
- **Уведомления Toast** о прогрессе подключения.
- **Graceful degradation** для несовместимых серверов.
- **Fallback UI** вместо ошибок.

### Устранение неполадок

- **Ошибка HTTP 401**: Решается получением нового `sessionId` и тестированием с ним.
- **Инструменты не отображаются**: Проверка `localStorage`, убеждение, что `fetchAndAssignTools` не блокирует сохранение, и ожидание автоматического подключения.
