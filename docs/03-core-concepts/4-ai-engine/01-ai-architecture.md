# ü§ñ AI Engine & Streaming Architecture

**–í–µ—Ä—Å–∏—è:** 2025-07-03 **–°—Ç–∞—Ç—É—Å:** ‚úÖ Canonical

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–≤–∏–∂–∫–∞ –ò–ò –≤ `shell` –∏ –µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å UI-—Å–ª–æ–µ–º (`neira-app`) –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –æ—Ç–≤–µ—Ç–æ–≤.

---

## 1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∏—Ö —Ä–æ–ª–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç                | –°–ª–æ–π        | –ó–æ–Ω–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏                                                                                                                                                        |
| ------------------------ | ----------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `APIManager`             | `shell`     | **–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —à–ª—é–∑.** –ü—Ä–∏–Ω–∏–º–∞–µ—Ç IPC-–∑–∞–ø—Ä–æ—Å—ã `api-chat`, –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, –≤—ã–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–∏–º–∏–Ω–≥, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç tool-calling –∏ –ø—É—à–∏—Ç —Å–æ–±—ã—Ç–∏—è `chat:stream-chunk` –æ–±—Ä–∞—Ç–Ω–æ –≤ UI. |
| `OpenRouterModelService` | `shell`     | **–†–µ–µ—Å—Ç—Ä –º–æ–¥–µ–ª–µ–π.** –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–∫–æ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π, –∏—Ö —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ tools, –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ–∫–Ω–æ) –∏ —Ç–∞—Ä–∏—Ñ–∞–º–∏.                                                      |
| `TariffService`          | `shell`     | **–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞.** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏–º–µ–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ—Å—Ç—É–ø –∫ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–æ–π –º–æ–¥–µ–ª–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –µ–≥–æ —Ç–∞—Ä–∏—Ñ–Ω–æ–º—É –ø–ª–∞–Ω—É.                                                          |
| `useChatStreaming`       | `neira-app` | **–ü–æ–¥–ø–∏—Å—á–∏–∫ –Ω–∞ —Å—Ç—Ä–∏–º.** –°–ª—É—à–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ `chat:stream-chunk` –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç `chatSessionStore` (Zustand) –ø–æ –º–µ—Ä–µ –ø—Ä–∏—Ö–æ–¥–∞ —Ç–æ–∫–µ–Ω–æ–≤.                                               |
| `PolylithChatService`    | `shell`     | **–°–µ—Ä–≤–∏—Å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM.                                                                        |

---

## 2. –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö (Happy Path: Streaming)

```mermaid
sequenceDiagram
    participant UI as neira-app (useChatCore)
    participant IPC as window.neiraAPI
    participant API as APIManager
    participant LLM as AI Provider

    UI->>IPC: invoke('api-chat', payload)
    IPC->>API: handleChat(payload)
    activate API
    API->>LLM: POST /v1/chat/completions (stream: true)
    activate LLM
    loop For each token
        LLM-->>API: SSE chunk (delta)
        API->>IPC: broadcast('chat:stream-chunk', token)
        IPC-->>UI: (event triggers useChatStreaming)
        Note over UI: useChatStreaming -><br/>chatSessionStore.updateLastMessage()
    end
    LLM-->>API: SSE [DONE]
    deactivate LLM
    API-->>IPC: broadcast('chat:stream-chunk', { type: 'final' })
    deactivate API
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

1. **–ù–∞—Å—Ç–æ—è—â–∏–π SSE:** `APIManager` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä—è–º–æ–µ SSE-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º (OpenAI, OpenRouter) –∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç —á–∞–Ω–∫–∏ "as-is" —á–µ—Ä–µ–∑ IPC.
2. **–¢–æ–Ω–∫–∏–π UI-–∫–ª–∏–µ–Ω—Ç:** –í—Å—è –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏, –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –≤ `APIManager`. UI-—Å–ª–æ–π (`neira-app`) –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ.
3. **Graceful Fallback:** –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç API-–∫–ª—é—á–µ–π –¥–ª—è –ø—Ä—è–º–æ–≥–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –∏–ª–∏ –º–æ–¥–µ–ª—å –µ–≥–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç, `APIManager` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º, –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –æ–¥–Ω–∏–º `final` —á–∞–Ω–∫–æ–º.

---

## 3. –ú–∞–ø–ø–∏–Ω–≥ –º–æ–¥–µ–ª–µ–π –∏ –≤—ã–±–æ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

`APIManager` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è, –∫–∞–∫—É—é —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–∑–≤–∞—Ç—å:

| –ü—Ä–µ—Ñ–∏–∫—Å / –ü–∞—Ç—Ç–µ—Ä–Ω    | –ü—Ä–æ–≤–∞–π–¥–µ—Ä  | –ú–µ—Ç–æ–¥ –≤ `APIManager`           | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SSE     |
| -------------------- | ---------- | ------------------------------ | ----------------- |
| `gpt-*`              | OpenAI     | `streamOpenAIResponse()`       | ‚úÖ                |
| `*/` (—Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª—ç—à) | OpenRouter | `streamOpenRouterResponse()`   | ‚úÖ                |
| _–ø—Ä–æ—á–µ–µ_             | (N/A)      | `generateAIResponse()` (–±—É—Ñ–µ—Ä) | ‚ùå                |
| `claude-*`           | Anthropic  | `generateAIResponse()` (–±—É—Ñ–µ—Ä) | ‚è≥ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ) |

---

## 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

| –°—Ü–µ–Ω–∞—Ä–∏–π                | –ü–æ–≤–µ–¥–µ–Ω–∏–µ `APIManager`                                                      | –†–µ–∞–∫—Ü–∏—è UI                                                                            |
| ----------------------- | --------------------------------------------------------------------------- | ------------------------------------------------------------------------------------- |
| `429 Too Many Requests` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π (–¥–æ 3 —Ä–∞–∑).               | UI –Ω–µ –≤–∏–¥–∏—Ç –æ—à–∏–±–∫–∏, –ø—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π.                                |
| –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ / SSE       | `APIManager` –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É –∏ –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤ –±—É—Ñ–µ—Ä–Ω–æ–º —Ä–µ–∂–∏–º–µ. | –û—Ç–≤–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ–¥–Ω–∏–º —Ü–µ–ª—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –≤–º–µ—Å—Ç–æ –ø–æ—Ç–æ–∫–∞.                                  |
| –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π API-–∫–ª—é—á     | –û—à–∏–±–∫–∞ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç—Å—è –≤ UI.                                    | –í `chatSessionStore` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ–ª–µ `error`, UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ. |
| Tool Timeout            | `APIManager` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.                      | –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ —á–∞—Ç–µ.                                              |

---

## 5. Revision History

| –î–∞—Ç–∞       | –í–µ—Ä—Å–∏—è | –ê–≤—Ç–æ—Ä      | –ò–∑–º–µ–Ω–µ–Ω–∏–µ                                                                                       |
| ---------- | ------ | ---------- | ----------------------------------------------------------------------------------------------- |
| 2025-07-03 | 2.1    | @ai-dev    | –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É Daebak 2.0. –£–¥–∞–ª–µ–Ω `useNeiraChat`, –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–æ–ª—å `TariffService`. |
| 2025-07-02 | 2.0    | @docs-team | –ü–æ–ª–Ω–æ–µ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ä–∞–∑–¥–µ–ª—ã Error Matrix & Security.                                   |
