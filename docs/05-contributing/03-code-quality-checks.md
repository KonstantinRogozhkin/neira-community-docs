# Проверки качества кода в NEIRA Super App

## Введение

В проекте NEIRA Super App внедрена система автоматических проверок качества кода, которая запускается перед каждым коммитом. Эти проверки помогают обеспечивать высокое качество кода, предотвращать утечки чувствительной информации и соблюдать лицензионные требования.

## Pre-commit проверки

При выполнении команды `git commit` автоматически запускаются следующие проверки:

1. **Проверка размера кеша** — предотвращает коммиты при переполнении кеша
2. **Генерация списка IPC-каналов** — обновляет список разрешенных IPC-каналов
3. **Проверка секретов** — сканирует код на наличие API ключей, токенов, паролей и персональных данных
4. **Проверка лицензий** — проверяет совместимость лицензий зависимостей с GPL-3.0
5. **Lint-staged** — запускает линтеры и проверки типов на измененных файлах

Если какая-либо из этих проверок не проходит, коммит будет отклонен с соответствующим сообщением об ошибке.

## Проверка секретов

Проверка секретов выполняется скриптом `scripts/utils/secrets-scan.js`, который сканирует код на наличие:

- API ключей
- Токенов доступа
- Приватных ключей
- Паролей
- Персональных данных (email, телефоны)

### Запуск проверки секретов вручную

```bash
# Проверка всех файлов
yarn secrets-scan

# Проверка только файлов, подготовленных к коммиту
yarn secrets-scan:staged

# Автоматическое исправление найденных секретов (замена на переменные окружения)
yarn secrets-scan:fix

# Подробный вывод информации
yarn secrets-scan --verbose
```

### Что делать, если найдены секреты

Если в коде обнаружены секреты, вы должны:

1. **Удалить секреты из кода** — никогда не коммитьте API ключи, пароли и другую чувствительную информацию
2. **Использовать переменные окружения** — храните секреты в `.env` файле (не добавляйте его в git)
3. **Создать пример .env файла** — добавьте `.env.example` с примерами переменных без реальных значений

Пример использования переменных окружения:

```typescript
// Вместо этого (НЕПРАВИЛЬНО)
const apiKey = 'sk-1234567890abcdef';

// Используйте это (ПРАВИЛЬНО)
const apiKey = process.env.API_KEY;
```

## Проверка лицензий

Проверка лицензий выполняется скриптом `scripts/utils/license-check.js`, который проверяет совместимость лицензий всех зависимостей с лицензией проекта (GPL-3.0).

### Запуск проверки лицензий вручную

```bash
# Проверка лицензий
yarn license-check

# Автоматическое добавление исключений в .npmrc
yarn license-check:fix

# Подробный вывод информации
yarn license-check:verbose

# Вывод в формате JSON
yarn license-check --json
```

### Категории лицензий

Лицензии делятся на следующие категории:

1. **Разрешительные** — MIT, BSD, Apache и т.д. (совместимы с GPL-3.0)
2. **Копилефт** — GPL, LGPL, MPL и т.д. (могут быть совместимы с GPL-3.0)
3. **Коммерческие** — Proprietary, Commercial (несовместимы с GPL-3.0)
4. **Проблемные** — AGPL, CC-BY-NC и т.д. (требуют особого внимания)

### Что делать при конфликтах лицензий

Если обнаружены несовместимые лицензии:

1. **Найдите альтернативную библиотеку** с совместимой лицензией
2. **Свяжитесь с автором библиотеки** для уточнения лицензии
3. **Добавьте исключение** в `.npmrc` (только для некритичных зависимостей)
4. **Обсудите с командой** возможность использования библиотеки с несовместимой лицензией

## Lint-staged

Lint-staged запускает линтеры и проверки типов только на измененных файлах, что ускоряет процесс проверки.

Конфигурация lint-staged находится в `package.json`:

```json
"lint-staged": {
  "*.{js,jsx,ts,tsx}": [
    "eslint --fix",
    "prettier --write"
  ],
  "*.{json,css,md}": "prettier --write",
  "packages/**/*.{ts,tsx}": "cd packages/neira-app && npx tsc --noEmit",
  "packages/shell/**/*.{ts,tsx}": "cd packages/shell && npx tsc --noEmit"
}
```

## Отключение проверок

В исключительных случаях, когда необходимо временно отключить pre-commit проверки, можно использовать флаг `--no-verify`:

```bash
git commit -m "Срочный коммит" --no-verify
```

**ВАЖНО**: Используйте эту опцию только в крайних случаях и обязательно запустите проверки вручную после коммита.

## Автоматизация обновления статуса эпиков

Для автоматического обновления статуса эпиков после их завершения используется скрипт `scripts/docs/build-docs.js`:

```bash
# Обновление статуса эпика
yarn update-epic-status --epic=<epic-slug>

# Обновление статуса эпика в конкретном спринте
yarn update-epic-status --epic=<epic-slug> --sprint=<путь-к-директории-спринта>
```

Скрипт выполняет следующие действия:

1. Переименовывает файл эпика, добавляя префикс `[DONE]-`
2. Обновляет README.md спринта, добавляя статус ✓ к ссылке на эпик
3. Обновляет таблицу статусов в README.md спринта

## Достижения в области качества кода

### Стабилизация ядра и архитектурные улучшения

В рамках спринта стабилизации (stabilization-core-refactoring-2025-07) были внедрены:

- **Pre-Commit проверки качества кода** — автоматические проверки перед каждым коммитом
- **Стабилизация Core компонентов** — исправление критических ошибок ядра
- **Архитектурный рефакторинг** — устранение технического долга
- **Оптимизация производительности** — повышение качества кодовой базы

### Безопасность и стабильность

Завершена миграция на архитектуру Polylith и консолидация IPC-каналов:

- **Устранение критических уязвимостей** — исправление проблем безопасности
- **Консолидация IPC-каналов** — унификация межпроцессного взаимодействия
- **Стабилизация Python Agent** — улучшение gRPC-соединений
- **Улучшение UX** — исправление проблем с фокусом окон

## Добавление новых проверок

Если вы хотите добавить новую проверку качества кода:

1. Создайте скрипт в директории `scripts/utils/`
2. Добавьте команду для запуска скрипта в `package.json`
3. Добавьте вызов скрипта в `.husky/pre-commit`
4. Обновите эту документацию

## Рекомендации по качеству кода

- **Следуйте стандартам кодирования** — используйте ESLint и Prettier
- **Пишите тесты** — поддерживайте высокое покрытие кода тестами
- **Избегайте дублирования** — используйте принцип DRY (Don't Repeat Yourself)
- **Документируйте код** — добавляйте комментарии и JSDoc
- **Регулярно обновляйте зависимости** — следите за обновлениями библиотек
- **Используйте типизацию** — TypeScript помогает предотвратить ошибки

## Заключение

Автоматические проверки качества кода помогают поддерживать высокое качество кодовой базы и предотвращать распространенные проблемы. Однако они не заменяют код-ревью и ответственный подход к разработке. Всегда проверяйте свой код перед коммитом и следуйте лучшим практикам разработки.
