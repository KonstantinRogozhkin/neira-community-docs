# ðŸ“– Chat Core Architecture

**Ð’ÐµÑ€ÑÐ¸Ñ:** 2025-07-03 **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** âœ… Canonical

Ð­Ñ‚Ð¾Ñ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ â€” ÐµÐ´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¿Ñ€Ð°Ð²Ð´Ñ‹ Ð¿Ð¾ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ðµ Ñ‡Ð°Ñ‚Ð° Ð² `neira-app`. ÐžÐ½ Ð¾Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ðµ Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° _Daebak 2.0_, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑƒÐ½Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð» ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· `Zustand` Ð¸ `React Query`.

---

## 1. Ð¤Ð¸Ð»Ð¾ÑÐ¾Ñ„Ð¸Ñ Ð¸ Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹

ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° Ñ‡Ð°Ñ‚Ð° ÑÐ»ÐµÐ´ÑƒÐµÑ‚ Ð¿Ñ€Ð¸Ð½Ñ†Ð¸Ð¿Ñƒ **SSOT (Single Source of Truth)** Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ‚Ð¸Ð¿Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ð´ÐµÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¸ "Ð³Ð¾Ð½ÐºÐ¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¹".

1. **`chatSessionStore` (Zustand) â€” Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¿Ñ€Ð°Ð²Ð´Ñ‹ Ð´Ð»Ñ UI.**

    - **ÐžÑ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð·Ð°:** Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð² ÑÐµÑÑÐ¸Ð¸, ÑÑ‚Ð°Ñ‚ÑƒÑ (`loading`, `streaming`), ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð¾Ð»Ñ Ð²Ð²Ð¾Ð´Ð° (`input`), Ð¾ÑˆÐ¸Ð±ÐºÐ¸.
    - **Ð–Ð¸Ð·Ð½ÐµÐ½Ð½Ñ‹Ð¹ Ñ†Ð¸ÐºÐ»:** Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð²Ñ…Ð¾Ð´Ðµ Ð² Ñ‡Ð°Ñ‚ Ð¸ Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð²Ñ‹Ñ…Ð¾Ð´Ðµ. Ð­Ñ‚Ð¾ ÑÑ„ÐµÐ¼ÐµÑ€Ð½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ, Ð¶Ð¸Ð²ÑƒÑ‰ÐµÐµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸.
    - **ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ Zustand?** Ð˜Ð´ÐµÐ°Ð»ÐµÐ½ Ð´Ð»Ñ Ñ‡Ð°ÑÑ‚Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼Ð¾Ð³Ð¾, ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ð³Ð¾ UI-ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ. `Immer`-Ð¼Ð¸Ð´Ð»Ð²Ð°Ñ€Ð° Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ Ð¸Ð¼Ð¼ÑƒÑ‚Ð°Ð±ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ.

2. **React Query â€” ÐºÑÑˆ Ð´Ð»Ñ ÑÐµÑ€Ð²ÐµÑ€Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ….**

    - **ÐžÑ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð·Ð°:** ÑÐ¿Ð¸ÑÐ¾Ðº Ñ‡Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (`['chats', userId]`) Ð¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð° (`['chat', chatId]`).
    - **Ð–Ð¸Ð·Ð½ÐµÐ½Ð½Ñ‹Ð¹ Ñ†Ð¸ÐºÐ»:** Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÑŽÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· IPC, ÐºÑÑˆÐ¸Ñ€ÑƒÑŽÑ‚ÑÑ Ð¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¸Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ, Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°Ñ ÐºÐ¾Ð½ÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ð½Ð¾ÑÑ‚ÑŒ Ñ `shell`.
    - **ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ React Query?** Ð£Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ð¼Ð¸ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸ÑÐ¼Ð¸ (Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°, Ð¾ÑˆÐ¸Ð±ÐºÐ¸), Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¹ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹ Ð¸ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸ÑÑ‚Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÑÐ¼Ð¸.

3. **ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ â€” Â«Ð³Ð»ÑƒÐ¿Ñ‹ÐµÂ» Ð¸ Ð´ÐµÐºÐ»Ð°Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ.**
    - UI-ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ (`Chat`, `MessageList`, `ChatInputArea`) **Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð¹ Ð»Ð¾Ð³Ð¸ÐºÐ¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ**.
    - ÐžÐ½Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‚ÑÑ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ð½Ð° `useChatSessionStore` Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÑŽÑ‚ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸ ÑÐºÑˆÐµÐ½Ñ‹. ÐŸÑ€Ð¾Ð¿-Ð´Ñ€Ð¸Ð»Ð»Ð¸Ð½Ð³ ÑÐ²ÐµÐ´ÐµÐ½ Ðº Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼Ñƒ.

---

## 2. ÐŸÐ¾Ñ‚Ð¾Ðº Ð´Ð°Ð½Ð½Ñ‹Ñ…: Ð¾Ñ‚ Ð²Ð²Ð¾Ð´Ð° Ð´Ð¾ Ð¾Ñ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÐ¸ Ñ‚Ð¾ÐºÐµÐ½Ð°

ÐšÐ»ÑŽÑ‡ÐµÐ²Ð¾Ð¹ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ â€” Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð²Ð¾Ð³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð°.

```mermaid
sequenceDiagram
    participant Cmp as ChatInputArea
    participant Store as chatSessionStore
    participant Core as useChatCore
    participant IPC as window.neiraAPI
    participant API as APIManager (shell)
    participant LLM as AI Provider

    Cmp->>Store: setInput("Hello")
    Cmp->>Core: append()
    Core->>Store: addMessage({ role: 'user', ... })
    Core->>Store: setStatus('submitted')
    Core->>IPC: invoke('api-chat', payload)
    IPC->>API: handleChat(payload)
    activate API
    API->>LLM: SSE Request
    activate LLM

    loop Streaming Response
        LLM-->>API: token chunk
        API->>IPC: broadcast('chat:stream-chunk', chunk)
        IPC-->>Core: (event listener)
        Core->>Store: updateLastMessage(token)
        Store-->>Cmp: re-render with new token
    end

    LLM-->>API: [DONE]
    deactivate LLM
    API->>Core: (resolves invoke)
    deactivate API
    Core->>Store: setStatus('ready')
```

**ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ñ‹:**

- **ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸ÑÑ‚Ð¸Ñ‡Ð½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ:** Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ÑÑ Ð² `chatSessionStore` _Ð´Ð¾_ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€.
- **ÐžÐ´Ð½Ð¾Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð¿Ð¾Ñ‚Ð¾Ðº:** UI Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ ÑÐºÑˆÐµÐ½Ñ‹, `useChatCore` Ð¾Ñ€ÐºÐµÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÑ‚ IPC, `APIManager` Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ AI, ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ ÑÑ‚Ñ€Ð¸Ð¼Ð¸Ð½Ð³Ð° Ð»ÐµÑ‚ÑÑ‚ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑŽÑ‚ ÑÑ‚Ð¾Ñ€, Ñ‡Ñ‚Ð¾ Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ñ€Ðµ-Ñ€ÐµÐ½Ð´ÐµÑ€ UI.
- **Ð”ÐµÐºÐ¾Ð¼Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ñ:** `useChatCore` Ð½Ðµ Ð·Ð°Ð½Ð¸Ð¼Ð°ÐµÑ‚ÑÑ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ°Ð¼Ð¸ Ð½Ð° ÑÑ‚Ñ€Ð¸Ð¼Ð¸Ð½Ð³. Ð­Ñ‚Ñƒ Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð¸Ð½ÐºÐ°Ð¿ÑÑƒÐ»Ð¸Ñ€ÑƒÐµÑ‚ Ñ…ÑƒÐº `useChatStreaming`, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ `useChatCore`.

---

## 3. ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ñ…ÑƒÐºÐ¸ Ð¸ Ð¸Ñ… Ð·Ð¾Ð½Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸

| Ð¥ÑƒÐº                   | Ð—Ð¾Ð½Ð° Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸                                                                             | ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸                                        |
| --------------------- | ------------------------------------------------------------------------------------------------ | ----------------------------------------------------------- |
| `useChatCore`         | **ÐžÑ€ÐºÐµÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€.** Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ Ð²ÑÐµ Ñ‡Ð°ÑÑ‚Ð¸ Ð²Ð¼ÐµÑÑ‚Ðµ, ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ `append`, Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ IPC.      | `useChatSessionStore`, `useChatSession`, `useChatStreaming` |
| `useChatSessionStore` | **Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ ÑÐµÑÑÐ¸Ð¸ (Zustand).** Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ, ÑÑ‚Ð°Ñ‚ÑƒÑ, input. ÐŸÑ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ ÑÐºÑˆÐµÐ½Ñ‹.           | `zustand`, `immer`                                          |
| `useChatSession`      | **ÐšÑÑˆ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ (React Query).** Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ Ð¸ ÐºÑÑˆÐ¸Ñ€ÑƒÐµÑ‚ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ `chatId`.              | `@tanstack/react-query`                                     |
| `useChatStreaming`    | **ÐŸÐ¾Ð´Ð¿Ð¸ÑÑ‡Ð¸Ðº Ð½Ð° IPC.** Ð¡Ð»ÑƒÑˆÐ°ÐµÑ‚ `chat:stream-chunk` Ð¸ Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ ÑÐºÑˆÐµÐ½Ñ‹ ÑÑ‚Ð¾Ñ€Ð° (`updateLastMessage`). | `window.neiraAPI`                                           |
| `useChatState`        | **Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ UI-ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°.** Ð£Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ID Ñ‡Ð°Ñ‚Ð°, ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÑ URL Ð¸ ÑÑ‚Ð¾Ñ€.                        | `useChatUIStore`                                            |

---

## 4. Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ‡Ð°Ñ‚Ð°

### 4.1 Ð ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð¸ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ

- **Ð˜Ð¼Ð¼ÑƒÑ‚Ð°Ð±ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ:** Ð’ÑÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑÐ¾Ð·Ð´Ð°ÑŽÑ‚ Ð½Ð¾Ð²Ñ‹Ðµ Ð¾Ð±ÑŠÐµÐºÑ‚Ñ‹/Ð¼Ð°ÑÑÐ¸Ð²Ñ‹
- **Minimal re-renders:** ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÑŽÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Ð½ÑƒÐ¶Ð½ÑƒÑŽ Ñ‡Ð°ÑÑ‚ÑŒ ÑÑ‚Ð¾Ñ€Ð°
- **Streaming optimizations:** Ð¢Ð¾ÐºÐµÐ½Ñ‹ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑŽÑ‚ÑÑ Ð±ÐµÐ· Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²ÑÐµÐ³Ð¾ Ð¼Ð°ÑÑÐ¸Ð²Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹

### 4.2 ÐžÑ‚ÐºÐ°Ð·Ð¾ÑƒÑÑ‚Ð¾Ð¹Ñ‡Ð¸Ð²Ð¾ÑÑ‚ÑŒ

- **Graceful degradation:** ÐŸÑ€Ð¸ ÑÐ±Ð¾Ðµ ÑÑ‚Ñ€Ð¸Ð¼Ð¸Ð½Ð³Ð° Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÑ‚ÑÑ Ñ‡Ð°ÑÑ‚Ð¸Ñ‡Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
- **Error boundaries:** React Error Boundaries Ð¸Ð·Ð¾Ð»Ð¸Ñ€ÑƒÑŽÑ‚ ÑÐ±Ð¾Ð¸ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð²
- **Retry logic:** ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ñ‹ Ð¿Ñ€Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… ÑÐ±Ð¾ÑÑ…

### 4.3 Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼Ð¾ÑÑ‚ÑŒ

```typescript
// ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ‡Ð°Ñ‚-Ð»Ð¾Ð³Ð¸ÐºÐ¸
describe('Chat State Management', () => {
  it('should add message optimistically', () => {
    const store = useChatSessionStore.getState()
    store.addMessage({ role: 'user', content: 'test' })
    expect(store.messages).toHaveLength(1)
  })
})
``` 