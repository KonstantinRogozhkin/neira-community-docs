# Диагностика критических системных проблем

Этот гайд охватывает проблемы с фундаментальными системами приложения, такими как загрузка AI-моделей и работа с базой данных.

## 1. Проблемы с загрузкой AI-моделей

- **Симптомы:**
  - Приложение "зависает" на экране загрузки.
  - Отображается "⚠️ Ошибка загрузки моделей" в интерфейсе.
  - Кнопка отправки сообщений неактивна.
  - В логах: `❌ OPENROUTER_API_KEY is NOT SET` или `❌ Failed to parse cache file as JSON`.

- **Причины и решения:**

  1. **Отсутствует `OPENROUTER_API_KEY`:**
     - Убедитесь, что ключ добавлен в `.env.local` и загружен в окружение.

  2. **Поврежден кэш моделей:**
     - Удалите файл кэша и перезапустите приложение для его повторной загрузки.

       ```bash
       rm -f packages/shell/resources/openrouter-models.json
       yarn start:full
       ```

  3. **Проблемы с сетью:**
     - Проверьте доступность OpenRouter API (`curl -I "https://openrouter.ai/api/v1/models"`) и DNS (`nslookup openrouter.ai`).

  4. **Проблемы со сборкой (production):**
     - Убедитесь, что `openrouter-models.json` включен в ресурсы production-сборки.

- **Экстренное восстановление:**
  - Используйте флаг `--force-refresh-models` для принудительного обновления кэша моделей при запуске.

    ```bash
    yarn start:full --force-refresh-models
    ```

## 2. Проблемы с базой данных (SQLite)

- **Ключевое правило:** Миграции Drizzle **обязательны** перед первым запуском. Схема больше не создается автоматически.

- **Симптомы и решения:**

| Сообщение об ошибке | Причина | Решение |
| :--- | :--- | :--- |
| `no such table: chats` | Миграции не были применены. | Запустите `DATABASE_URL=./neira.db yarn db:migrate`. |
| `Error: SQLITE_ERROR: foreign key mismatch` | Используется БД со старым форматом схемы. | Удалите старый файл `neira.db` и примените миграции заново. |

- **Процесс для чистого старта:**

  ```bash
  # 1. Удалить старую БД (если есть)
  rm -f neira.db

  # 2. Применить все миграции
  DATABASE_URL=./neira.db yarn db:migrate
  ```
